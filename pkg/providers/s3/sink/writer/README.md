# Пакет S3 Sink Writer

## Обзор

Пакет `writer` предоставляет гибкую обёртку над интерфейсом `io.WriteCloser` из Go, которая обрабатывает сжатие данных для загрузки в S3. Поддерживает несколько форматов сжатия и обеспечивает корректную очистку ресурсов через многослойный механизм закрытия.

## Назначение

Этот пакет используется S3 sink для:
- Применения сжатия к данным перед загрузкой в S3
- Управления жизненным циклом нескольких вложенных writer'ов (сжатие + базовый writer)
- Обеспечения корректного сброса буферов и закрытия всех слоёв writer'ов

## Архитектура

### Структура Writer

```go
type Writer struct {
    io.WriteCloser           // Основной writer (например, gzip.Writer, zlib.Writer или raw writer)
    wrappedCloser []io.Closer // Дополнительные closer'ы, которые нужно закрыть (например, pipeWriter)
}
```

`Writer` оборачивает один или несколько экземпляров `io.Closer` для обеспечения корректной очистки:
1. **Основной WriteCloser**: Writer сжатия (gzip/zlib) или raw writer
2. **Обёрнутые Closer'ы**: Базовые writer'ы, требующие очистки (например, pipe writer'ы для потоковой загрузки)

### Порядок закрытия

Последовательность закрытия критична для целостности данных:

```
┌─────────────────────────────────────────────────────────┐
│                Последовательность Close                 │
│                                                         │
│  1. Закрыть WriteCloser (например, gzip.Writer)        │
│     └─> Сбросить все буферизованные сжатые данные      │
│                                                         │
│  2. Закрыть wrappedCloser (например, pipeWriter)       │
│     └─> Сигнализировать EOF горутине загрузки          │
│                                                         │
│  Этот порядок обеспечивает:                             │
│  - Все данные сжаты и сброшены                          │
│  - Загрузка завершается со всеми данными                │
│  - Нет потери или повреждения данных                    │
└─────────────────────────────────────────────────────────┘
```

## Поддерживаемые форматы сжатия

Пакет поддерживает три режима кодирования:

| Кодирование | Описание | Применение |
|-------------|----------|------------|
| `GzipEncoding` | Сжатие GZIP | Стандартное сжатие, широко поддерживается |
| `ZlibEncoding` | Сжатие ZLIB | Альтернативный формат сжатия |
| Нет (по умолчанию) | Без сжатия | Передача сырых данных |

## API

### NewWriter

Создаёт новый writer с указанным форматом сжатия.

```go
func NewWriter(outputEncoding s3_provider.Encoding, rawWriter io.WriteCloser) io.WriteCloser
```

**Параметры:**
- `outputEncoding`: Формат сжатия (`GzipEncoding`, `ZlibEncoding` или без сжатия)
- `rawWriter`: Базовый writer (обычно pipe writer, подключённый к S3 uploader)

**Возвращает:**
- `io.WriteCloser`: Writer, применяющий указанное сжатие

**Пример:**
```go
// Создать writer с GZIP сжатием
writer := NewWriter(s3_provider.GzipEncoding, pipeWriter)

// Записать данные
_, err := writer.Write(data)
if err != nil {
    return err
}

// Закрыть для сброса и финализации
err = writer.Close()
```

### Write

Записывает данные через слой сжатия.

```go
func (w *Writer) Write(p []byte) (int, error)
```

Делегирует вызов методу `WriteCloser.Write()` базового writer'а.

### Close

Закрывает все слои writer'ов в правильном порядке.

```go
func (w *Writer) Close() error
```

**Поведение:**
1. Закрывает основной `WriteCloser` (writer сжатия) для сброса всех буферизованных данных
2. Закрывает все экземпляры `wrappedCloser` по порядку
3. Возвращает первую встреченную ошибку, если таковая имеется

**Важно:** Всегда вызывайте `Close()` для обеспечения:
- Сброса всех сжатых данных
- Освобождения базовых ресурсов
- Успешного завершения загрузки в S3

## Использование в S3 Sink

Writer используется в пайплайне записи в S3:

```
┌─────────────────────────────────────────────────────────┐
│              Пайплайн загрузки в S3                     │
│                                                         │
│  ChangeItems → Serializer → Writer → Pipe → S3 Upload   │
│                              ↑                          │
│                              │                          │
│                          Сжатие                         │
│                      (gzip/zlib/нет)                    │
└─────────────────────────────────────────────────────────┘
```

### Пример интеграции

```go
// Создать pipe для потоковой загрузки
pipeReader, pipeWriter := io.Pipe()

// Создать writer со сжатием
writer := writer.NewWriter(cfg.OutputEncoding, pipeWriter)

// Запустить загрузку в S3 в фоне
go func() {
    _, err := uploader.Upload(&s3manager.UploadInput{
        Bucket: aws.String(bucket),
        Key:    aws.String(key),
        Body:   pipeReader,
    })
    // Обработать ошибку
}()

// Записать данные
data, err := serializer.Serialize(items)
if err != nil {
    return err
}

_, err = writer.Write(data)
if err != nil {
    return err
}

// Закрыть для финализации загрузки
err = writer.Close()
if err != nil {
    return err
}
```

## Детали реализации

### Вспомогательная функция withCloser

Внутренняя вспомогательная функция, которая оборачивает writer дополнительным closer'ом:

```go
func withCloser(w io.WriteCloser, closer io.Closer) io.WriteCloser
```

Используется для связывания writer'а сжатия с базовым pipe writer'ом.

### Writer'ы сжатия

- **GZIP**: Использует `compress/gzip.NewWriter()` - обеспечивает хорошую степень сжатия
- **ZLIB**: Использует `compress/zlib.NewWriter()` - альтернативный формат сжатия
- **Без сжатия**: Прямая передача в raw writer - нет накладных расходов на сжатие
